# =============================================================================
# Nginx Virtual Host: wedlistfy.com
# Laravel Application
# =============================================================================

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name wedlistfy.com www.wedlistfy.com;
    
    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }
    
    # Redirect all other requests to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS Server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name wedlistfy.com www.wedlistfy.com;
    
    # Document root for nginx (static files)
    root /var/www/wedlistfy.com/public;
    index index.php index.html;
    
    # SSL Certificates
    ssl_certificate /etc/letsencrypt/live/wedlistfy.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wedlistfy.com/privkey.pem;
    
    # Include SSL parameters
    include /etc/nginx/snippets/ssl-params.conf;
    
    # Logging
    access_log /var/log/nginx/wedlistfy.com.access.log main;
    error_log /var/log/nginx/wedlistfy.com.error.log warn;
    
    # Rate limiting
    limit_req zone=general burst=20 nodelay;
    limit_conn addr 50;
    
    # Security headers
    include /etc/nginx/snippets/security-headers.conf;
    
    # -------------------------------------------------------------------------
    # Static Files
    # -------------------------------------------------------------------------
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        access_log off;
        try_files $uri =404;
    }
    
    # -------------------------------------------------------------------------
    # Robots.txt & Favicon
    # -------------------------------------------------------------------------
    location = /robots.txt { access_log off; log_not_found off; }
    location = /favicon.ico { access_log off; log_not_found off; }
    
    # -------------------------------------------------------------------------
    # Block access to sensitive files
    # -------------------------------------------------------------------------
    location ~ /\.(?!well-known) { deny all; access_log off; log_not_found off; }
    location ~ /\.env { deny all; }
    location ~ /\.git { deny all; }
    location ~ /composer\.(json|lock)$ { deny all; }
    location ~ /package(-lock)?\.json$ { deny all; }
    location ~ /webpack\.mix\.js$ { deny all; }
    location ~ ^/(storage|vendor|bootstrap/cache)/ { deny all; }
    
    # -------------------------------------------------------------------------
    # Laravel Application (PHP-FPM)
    # -------------------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass wedlistfy_com_backend;
        fastcgi_index index.php;
        
        # IMPORTANT: PHP-FPM container mounts to /var/www/html
        fastcgi_param SCRIPT_FILENAME /var/www/html/public$fastcgi_script_name;
        
        # Other FastCGI params
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param DOCUMENT_ROOT /var/www/html/public;
        fastcgi_param SERVER_PROTOCOL $server_protocol;
        fastcgi_param REQUEST_SCHEME $scheme;
        fastcgi_param HTTPS $https if_not_empty;
        fastcgi_param GATEWAY_INTERFACE CGI/1.1;
        fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;
        fastcgi_param REMOTE_ADDR $remote_addr;
        fastcgi_param REMOTE_PORT $remote_port;
        fastcgi_param SERVER_ADDR $server_addr;
        fastcgi_param SERVER_PORT $server_port;
        fastcgi_param SERVER_NAME $server_name;
        fastcgi_param REDIRECT_STATUS 200;
        
        # Buffers & Timeouts
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;
        fastcgi_keep_conn on;
        fastcgi_hide_header X-Powered-By;
    }
    
    # -------------------------------------------------------------------------
    # Health Check Endpoint
    # -------------------------------------------------------------------------
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
